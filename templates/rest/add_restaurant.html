{% extends 'partials/base.html'%}
{% load static %}
{% block content %}
<section class="add_rest section" id="add_rest"> 
  <h1>Add Restaurant</h1>
  <input type="text" id="search-input" placeholder="Search for a restaurant">
  <p>(Picks up location itself if it finds match, it takes a little time to load, so sit back and relax.)</p>
  <ul id="autocomplete-suggestions"></ul>
  <button id="add-manually">Add Manually</button>
  

  <div id="restaurant-form" style="display: none;">
    <h2>Restaurant Details</h2>
    <p>Looks like you could not find a match from the search bar, no worries you can add it manually.</p>
    <!-- Form for Adding Restaurant -->
    <form id="add-restaurant-form" method="POST" enctype="multipart/form-data">
        {% csrf_token %}
        
        <!-- Restaurant Name -->
        <label for="name">Restaurant Name:</label>
        <input type="text" id="name" name="name" required><br><br>
        
        <!-- Address Field -->
        <label for="address">Address:</label>
        <input type="text" id="address" name="address" required><br><br>

        <!-- Latitude and Longitude (Auto-filled) -->
        <label for="latitude">Latitude:</label>
        <input type="text" id="latitude" name="latitude" readonly><br><br>

        <label for="longitude">Longitude:</label>
        <input type="text" id="longitude" name="longitude" readonly><br><br>

        <label for="tags">Tags (e.g., Cafe, Fast Food):</label>
        <select id="tag-dropdown" name="tags" multiple required>
            <option value="" disabled>Select tags</option>
            {% for tag in tags %}
                <option value="{{ tag.name }}">{{ tag.name }}</option>
            {% endfor %}
        </select>
        <div id="selected-tags">
            <!-- Selected tags will be displayed here -->
        </div><br><br>

        <!-- Input for Adding New Tag -->
        <label for="new-tag">Add New Tag (if any):</label>
        <input type="text" id="new-tag" name="new_tag" placeholder="Enter a new tag">
        <button type="button" id="add-tag-button">Add Tag</button><br><br>

        <!-- Rating -->
        <label for="rating">Rating (1-5):</label>
        <input type="number" id="rating" name="rating" step="0.1" min="1" max="5" required><br><br>

        <!-- Review -->
        <label for="review">Review:</label>
        <textarea id="review" name="review"></textarea><br><br>

        <label for="image">Upload Image:</label>
        <input type="file" name="image" id="image" accept="image/*">

        <!-- Submit Button -->
        <button type="submit">Add Restaurant</button>
    </form>
    </div>
    <script>
      

      document.getElementById("add-tag-button").addEventListener("click", function() {
      const newTag = document.getElementById("new-tag").value.trim();
      if (newTag) {
        // Send the new tag to the server via AJAX
        fetch("{% url 'rest:add_tag' %}", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value
          },
          body: JSON.stringify({ tag_name: newTag })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            console.log("Tag added successfully:", newTag);
            // If tag added successfully, update the dropdown dynamically
            const tagDropdown = document.getElementById("tag-dropdown");
            const newOption = document.createElement("option");
            newOption.value = newTag;
            newOption.textContent = newTag;
            tagDropdown.appendChild(newOption);

            newOption.selected = true;

            // Clear the new tag input field
            document.getElementById("new-tag").value = '';
            } else {
              alert("Failed to add tag.");
            }
          })
          .catch(error => {
            console.error("Error adding tag:", error);
            alert("An error occurred while adding the tag.");
          });
        } else {
          alert("Please enter a tag name.");
        }
      });

      
      document.getElementById("tag-dropdown").addEventListener("change", function() {
      const selectedOptions = Array.from(this.selectedOptions);
      const selectedTags = selectedOptions.map(option => option.value);

      const selectedTagsContainer = document.getElementById("selected-tags");
      
      selectedTags.forEach(tag => {
        if (!Array.from(selectedTagsContainer.children).some(child => child.textContent.includes(tag))) {
            const tagElement = document.createElement("span");
            tagElement.classList.add("tag");
            tagElement.textContent = tag;

            const removeButton = document.createElement("button");
            removeButton.textContent = "X";
            removeButton.onclick = function () {
                tagElement.remove();
                const option = document.querySelector(`#tag-dropdown option[value='${tag}']`);
                if (option) option.selected = false;
            };

            tagElement.appendChild(removeButton);
            selectedTagsContainer.appendChild(tagElement);
        }
      });
    });


      

        const apiKey = "5453fd136f59455389f1b49116c65013";
        const searchInput = document.getElementById("search-input");
        const suggestions = document.getElementById("autocomplete-suggestions");
        const boundingBox = "filter=rect:82.9547896186507,25.20074192459107,83.05172449423014,25.310975518087687";
        const formContainer = document.getElementById("restaurant-form");
        const nameField = document.getElementById("name");
        const addManuallyButton = document.getElementById("add-manually");
        const addressField = document.getElementById("address");
        const latitudeField = document.getElementById("latitude");
        const longitudeField = document.getElementById("longitude");

        addManuallyButton.addEventListener("click", () => {
          latitudeField.style.backgroundColor="gray";
          longitudeField.style.backgroundColor="gray";

          latitudeField.disabled = true; // Make the cursor inactive for latitude
          longitudeField.disabled = true;


          formContainer.style.display = "block"; // Show the form

          nameField.value = ""; // Clear any pre-filled values
          addressField.value = "";
        });

      // Autocomplete functionality
      searchInput.addEventListener("input", () => {
        const text = searchInput.value;
        if (text.length > 2) {
          fetch(`https://api.geoapify.com/v1/geocode/autocomplete?text=${encodeURIComponent(text)}&${boundingBox}&format=json&apiKey=${apiKey}`)
            .then(response => response.json())
            .then(result => {
              suggestions.innerHTML = "";  // Clear existing suggestions
              result.results.forEach(item => {
                const li = document.createElement("li");
                li.textContent = item.formatted;

                // Event listener to handle selection of an address
                li.addEventListener("click", () => {
                  nameField.value = item.name || ""; // Set name if available
                  addressField.value = item.formatted;
                  latitudeField.style.backgroundColor = "white";
                  longitudeField.style.backgroundColor = "white";
                  fieldsDisabled = false; 
                  // Populate latitude and longitude fields
                  latitudeField.value = item.lat || "";  // Auto-fill latitude
                  longitudeField.value = item.lon || "";  // Auto-fill longitude

                  formContainer.style.display = "block";  // Show the form
                  suggestions.innerHTML = "";  // Clear suggestions
                });
                suggestions.appendChild(li);
              });
            })
            .catch(error => console.error("Error:", error));
        }
      });


      document.getElementById("add-restaurant-form").addEventListener("submit", (event) => {
          event.preventDefault();

          const selectedTags = Array.from(document.getElementById("tag-dropdown").selectedOptions)
          .map(option => option.value);
        
          const formData = new FormData(event.target);

          formData.delete("tags");

          selectedTags.forEach(tag => formData.append("tags", tag));



          fetch('/add_restaurant/', {
              method: 'POST',
              body: formData
          })
          .then(response => response.json())
          .then(data => {
              alert(data.message); // Success message
              event.target.reset();
              document.getElementById("search-input").value = "";
              formContainer.style.display = "none";
          })
          .catch(error => {
              alert('Error adding restaurant!');
          });
      });
    </script>


</section>



{% endblock%}
